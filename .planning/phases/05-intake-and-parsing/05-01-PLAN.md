---
phase: 05-intake-and-parsing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/design/INTAKE_GATEWAY_PLAN.md
autonomous: true

must_haves:
  truths:
    - "The intake gateway plan specifies the full request flow: auth, manifest validation, MIME check, size check, checksum verification, malware scan, object store write, receipt generation, audit event emission, job enqueue"
    - "The plan references PRD Section 2.1, 5.4; DOCUMENT_SAFETY Section 3; AUDIT_ARCHITECTURE Section 1.2"
  artifacts:
    - path: "docs/design/INTAKE_GATEWAY_PLAN.md"
      provides: "Step-by-step intake gateway implementation plan"
      min_lines: 400
---

<objective>
Create the intake gateway implementation plan: full request flow from vendor upload to canonical structured document JSON entry point. Auth, manifest validation, checksum, MIME, malware scan, object store write, receipts, audit events, job enqueue. API endpoint definitions and error response formats. An engineer must be able to execute the plan without asking clarifying questions.

Output: `docs/design/INTAKE_GATEWAY_PLAN.md`
</objective>

<context>
@docs/product/PRD.md (Section 2.1 Phase A, Section 5.4 Intake API)
@docs/security/DOCUMENT_SAFETY.md (Section 3: MIME verification, libmagic, allowlist)
@docs/architecture/AUDIT_ARCHITECTURE.md (Section 1.2: BATCH_RECEIVED, DOCUMENT_INGESTED, DOCUMENT_REJECTED, DOCUMENT_QUARANTINED)
@docs/reference/TECH_DECISIONS.md (python-magic, ClamAV, python-jose, python-multipart)
@docs/architecture/FOUNDATION_LAYER_PLAN.md (tenant config, emit_audit_event)
@docs/architecture/STORAGE_LAYER_PLAN.md (MinIO paths)
</context>

<tasks>

<task type="auto">
  <name>Write intake gateway implementation plan</name>
  <files>docs/design/INTAKE_GATEWAY_PLAN.md</files>
  <action>
Create `docs/design/INTAKE_GATEWAY_PLAN.md` with:

**1. Overview**
- Trust boundary role; first contact with untrusted documents
- Reference PRD Section 2.1, DOCUMENT_SAFETY Section 3

**2. Request Flow (Step-by-Step)**
- TLS termination (reject unencrypted)
- JWT validation: extract tenant_id, verify scope (ingest), reject expired/malformed
- Rate limit: 100 req/min per tenant (reference FOUNDATION_LAYER_PLAN tenant config)
- Manifest validation: parse JSON, verify file_count matches uploaded files, no duplicate file_ids
- Per-file loop: MIME (libmagic vs tenant mime_allowlist per DOCUMENT_SAFETY 3.2–3.5), size (max_file_size_mb), checksum (SHA-256 vs manifest), malware (ClamAV sidecar per TECH_DECISIONS #32), object store write (raw/{tenant_id}/{file_id}/{sha256}), receipt generation, audit emit, enqueue parse job
- Return batch receipt

**3. API Endpoint Definitions**
- POST /api/v1/ingest/{tenant_id}/batch — multipart (manifest JSON + files[]), 202 response schema, error codes (MANIFEST_INVALID, MANIFEST_FILE_COUNT_MISMATCH, DUPLICATE_FILE_ID, AUTHENTICATION_REQUIRED, etc.)
- GET /api/v1/ingest/{tenant_id}/batch/{batch_id} — status, per-file stages
- GET /api/v1/ingest/{tenant_id}/receipt/{receipt_id} — receipt detail

**4. Error Response Formats**
- 400, 401, 403, 429, 500 with code + message + details structure (per PRD 5.4)

**5. Audit Events**
- BATCH_RECEIVED (start), DOCUMENT_INGESTED (accepted), DOCUMENT_REJECTED (MIME/size/checksum), DOCUMENT_QUARANTINED (malware)
- Reference AUDIT_ARCHITECTURE Section 1 for schema, details fields

**6. Integration Points**
- MinIO (tenant bucket path), ClamAV (clamd socket), Redis/Celery (parse queue), audit emitter
  </action>
</task>

</tasks>

<success_criteria>
- docs/design/INTAKE_GATEWAY_PLAN.md exists, >= 400 lines
- Full flow: auth → manifest → MIME → size → checksum → malware → write → receipt → audit → enqueue
- API definitions with request/response schemas and error formats
- Explicit section references to Phase 3 and 4 docs
</success_criteria>

<output>
Create .planning/phases/05-intake-and-parsing/05-01-SUMMARY.md
</output>
