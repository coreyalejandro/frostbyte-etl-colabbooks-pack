---
phase: 04-foundation-and-storage-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/architecture/FOUNDATION_LAYER_PLAN.md
autonomous: true

must_haves:
  truths:
    - "The foundation layer plan specifies the tenant data model schema, configuration framework (env vars, secrets, feature flags), Docker Compose skeleton, and audit event emission pattern"
    - "The plan references docs/architecture/TENANT_ISOLATION_*.md and docs/architecture/AUDIT_ARCHITECTURE.md by specific section"
  artifacts:
    - path: "docs/architecture/FOUNDATION_LAYER_PLAN.md"
      provides: "Step-by-step foundation layer implementation plan"
      min_lines: 300
---

<objective>
Create the foundation layer implementation plan: tenant data model schema, configuration framework, Docker Compose skeleton, and audit event emission. An engineer must be able to execute the plan without asking clarifying questions.

Output: `docs/architecture/FOUNDATION_LAYER_PLAN.md`
</objective>

<context>
@docs/product/PRD.md (Section 3, Appendix G)
@docs/architecture/TENANT_ISOLATION_HETZNER.md
@docs/architecture/TENANT_ISOLATION_STORAGE_ENCRYPTION.md (Section 6: config, secrets)
@docs/architecture/AUDIT_ARCHITECTURE.md (Section 1, 2)
@.planning/phases/04-foundation-and-storage-layer/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Write foundation layer implementation plan</name>
  <files>docs/architecture/FOUNDATION_LAYER_PLAN.md</files>
  <action>
Create `docs/architecture/FOUNDATION_LAYER_PLAN.md` with:

**1. Tenant Data Model Schema**

- Complete SQL DDL for `tenants` table (control-plane DB)
- Columns: tenant_id, state, config (JSONB), config_version, created_at, updated_at, provisioning_started_at, provisioned_at, age_public_key, endpoints (JSONB)
- Reference PRD Section 3.1 (states), Appendix G (config schema)
- Indexes for state, created_at
- Migration file path: migrations/001_tenant_registry.sql

**2. Configuration Framework**

- Env vars table: FROSTBYTE_MODE, FROSTBYTE_CONTROL_DB_URL, FROSTBYTE_EMBEDDING_ENDPOINT, etc.
- Tenant config: loaded from tenants.config JSONB; validate against PRD Appendix G schema
- Secrets: per TENANT_ISOLATION_STORAGE_ENCRYPTION Section 6.5 (SOPS decrypt with tenant age key)
- Feature flags: document where they live (config JSON or separate table)

**3. Docker Compose Skeleton**

- Reference existing docker-compose.yml
- Add: control-plane postgres schema (tenants + audit_events), optional internal network for offline variant
- Document services: minio, postgres, redis, qdrant (existing) + audit schema init
- Migration order: 001_tenant_registry, then AUDIT_ARCHITECTURE Section 2.3 DDL
- Startup sequence: postgres up -> run migrations -> services ready

**4. Audit Event Emission**

- Reference AUDIT_ARCHITECTURE Section 1 (schema), Section 1.2 (event types)
- Foundation emits: TENANT_CREATED, TENANT_PROVISION_STARTED, TENANT_PROVISIONED, TENANT_CONFIG_UPDATED
- Code pattern: function `emit_audit_event(event_id, tenant_id, event_type, ...)` that INSERTs into audit_events
- Reference AUDIT_ARCHITECTURE Section 2.3 for table DDL
- Previous_event_id: null for tenant lifecycle events

**5. Cross-References**

- "Tenant states: PRD Section 3.1"
- "Config schema: PRD Appendix G"
- "Audit schema: AUDIT_ARCHITECTURE Section 1"
- "Secrets: TENANT_ISOLATION_STORAGE_ENCRYPTION Section 6"
- "Provisioning sequence: TENANT_ISOLATION_HETZNER Section 1, TENANT_ISOLATION_STORAGE_ENCRYPTION Section 10"
  </action>
</task>

</tasks>

<success_criteria>

- docs/architecture/FOUNDATION_LAYER_PLAN.md exists, >= 300 lines
- Tenant data model has complete DDL
- Config framework covers env, tenant config, secrets
- Docker skeleton documented with migration order
- Audit emission pattern with event types from AUDIT_ARCHITECTURE
</success_criteria>

<output>
Create .planning/phases/04-foundation-and-storage-layer/04-01-SUMMARY.md
</output>
