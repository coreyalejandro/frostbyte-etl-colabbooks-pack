---
phase: 04-foundation-and-storage-layer
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/architecture/STORAGE_LAYER_PLAN.md
autonomous: true

must_haves:
  truths:
    - "The storage layer plan specifies MinIO bucket provisioning, PostgreSQL database provisioning, Qdrant collection provisioning, and Redis setup — all with per-tenant credential generation and isolation verification steps"
    - "The plan references TENANT_ISOLATION_STORAGE_ENCRYPTION and AUDIT_ARCHITECTURE by specific section"
  artifacts:
    - path: "docs/architecture/STORAGE_LAYER_PLAN.md"
      provides: "Step-by-step storage layer implementation plan"
      min_lines: 400
---

<objective>
Create the storage layer implementation plan: MinIO, PostgreSQL, Qdrant, and Redis per-tenant provisioning with credential generation and isolation verification. An engineer must be able to execute the plan without asking clarifying questions.

Output: `docs/architecture/STORAGE_LAYER_PLAN.md`
</objective>

<context>
@docs/architecture/TENANT_ISOLATION_STORAGE_ENCRYPTION.md (Sections 2–5, 6, 10)
@docs/architecture/AUDIT_ARCHITECTURE.md (Section 2.3)
@docs/product/PRD.md (Section 3.4 steps 4–7, 3.6)
</context>

<tasks>

<task type="auto">
  <name>Write storage layer implementation plan</name>
  <files>docs/architecture/STORAGE_LAYER_PLAN.md</files>
  <action>
Create `docs/architecture/STORAGE_LAYER_PLAN.md` with:

**1. Overview**
- Map to PRD 3.4 steps 4–7 (storage provisioning)
- Reference TENANT_ISOLATION_STORAGE_ENCRYPTION Section 10 (combined sequence)
- Per-tenant isolation principle restated

**2. MinIO Provisioning**
- Step-by-step from TENANT_ISOLATION_STORAGE_ENCRYPTION Section 2
- Bucket create, IAM user, policy (complete JSON), attach
- Credential generation (openssl rand -base64 32)
- Verification commands (mc ls, cross-tenant denial test)
- Deprovisioning (Section 2.5)
- Reference: "TENANT_ISOLATION_STORAGE_ENCRYPTION Section 2"

**3. PostgreSQL Provisioning**
- Step-by-step from TENANT_ISOLATION_STORAGE_ENCRYPTION Section 3
- CREATE DATABASE, CREATE USER, GRANT, REVOKE CONNECT
- pg_hba.conf entry format
- Verification: connect as tenant user, cross-tenant denial
- Deprovisioning (Section 3.4)
- Reference: "TENANT_ISOLATION_STORAGE_ENCRYPTION Section 3"

**4. Qdrant Provisioning**
- Step-by-step from TENANT_ISOLATION_STORAGE_ENCRYPTION Section 4
- PUT /collections/tenant_{id} with vectors 768, Cosine
- Application guard: get_collection_name(tenant_id), verify_tenant_access
- Verification, deprovisioning
- Reference: "TENANT_ISOLATION_STORAGE_ENCRYPTION Section 4"

**5. Redis Provisioning**
- Step-by-step from TENANT_ISOLATION_STORAGE_ENCRYPTION Section 5
- Key prefix tenant:{id}:*
- ACL user creation (Redis >=6)
- Verification, deprovisioning
- Reference: "TENANT_ISOLATION_STORAGE_ENCRYPTION Section 5"

**6. Credential Generation and SOPS**
- From TENANT_ISOLATION_STORAGE_ENCRYPTION Section 6
- Age key gen, secrets YAML structure, SOPS encrypt
- Store in control plane; reference in tenant registry

**7. Combined Provisioning Sequence**
- Ordered steps 1–9 from Section 10
- Error handling: rollback on failure
- Audit: emit TENANT_PROVISIONED after Step 8 verification (reference AUDIT_ARCHITECTURE Section 1.2)

**8. Cross-References Table**
- Each store: "Isolation spec: TENANT_ISOLATION_STORAGE_ENCRYPTION Section X"
- Audit event schema: "AUDIT_ARCHITECTURE Section 1"
  </action>
</task>

</tasks>

<success_criteria>
- docs/architecture/STORAGE_LAYER_PLAN.md exists, >= 400 lines
- All four stores: provisioning, verification, deprovisioning
- Credential generation and SOPS workflow
- Combined sequence with rollback
- Explicit section references to Phase 2 and 3 docs
</success_criteria>

<output>
Create .planning/phases/04-foundation-and-storage-layer/04-02-SUMMARY.md
</output>
