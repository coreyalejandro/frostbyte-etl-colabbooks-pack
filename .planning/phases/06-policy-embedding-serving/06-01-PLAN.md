---
phase: 06-policy-embedding-serving
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/design/POLICY_ENGINE_PLAN.md
autonomous: true

must_haves:
  truths:
    - "The policy engine plan specifies PII detection rules, classification categories and routing logic, injection defense integration (referencing Phase 3 safety specs), and deterministic chunking with stable ID generation"
  artifacts:
    - path: "docs/design/POLICY_ENGINE_PLAN.md"
      provides: "Step-by-step policy engine implementation plan"
      min_lines: 450
---

<objective>
Create the policy engine implementation plan: PII detection (REDACT/FLAG/BLOCK), classification (rule-based + ML), injection defense (DOCUMENT_SAFETY Section 1), deterministic chunk IDs. Reference Phase 3 safety specs. An engineer must execute without clarifying questions.

Output: `docs/design/POLICY_ENGINE_PLAN.md`
</objective>

<context>
@docs/product/PRD.md (Section 2.3 Phase C)
@docs/security/DOCUMENT_SAFETY.md (Section 1: injection patterns, scorer, decision tree)
@docs/architecture/AUDIT_ARCHITECTURE.md (Section 1.2: POLICY_GATE_*, DOCUMENT_QUARANTINED, PII_DETECTED)
@docs/design/PARSING_PIPELINE_PLAN.md (canonical JSON, chunk schema)
</context>

<tasks>
<task type="auto">
  <name>Write policy engine implementation plan</name>
  <files>docs/design/POLICY_ENGINE_PLAN.md</files>
  <action>
Create docs/design/POLICY_ENGINE_PLAN.md with: (1) Overview â€” three gates run before embedding; (2) Gate 1 PII: NER scan, tenant actions REDACT/FLAG/BLOCK, PII types from PRD Appendix G; (3) Gate 2 Classification: rule-based then ML, categories (contract, invoice, SOP, etc.), review queue routing; (4) Gate 3 Injection: DOCUMENT_SAFETY Section 1 patterns, heuristic scorer, PASS/FLAG/QUARANTINE decision; (5) Chunk ID confirmation (deterministic from PARSING_PIPELINE_PLAN); (6) Policy-enriched chunk schema (Pydantic); (7) Audit events; (8) Online/offline mode (policy logic identical; classifiers may differ)
  </action>
</task>
</tasks>

<output>
Create 06-01-SUMMARY.md
</output>
