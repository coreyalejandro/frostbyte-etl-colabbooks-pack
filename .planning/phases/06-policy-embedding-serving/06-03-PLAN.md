---
phase: 06-policy-embedding-serving
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/SERVING_LAYER_PLAN.md
autonomous: true

must_haves:
  truths:
    - "The serving layer plan specifies the RAG retrieval flow, retrieval proof object schema, cite-only-from-retrieval enforcement mechanism, and the query-to-response lifecycle with audit event emission"
  artifacts:
    - path: "docs/SERVING_LAYER_PLAN.md"
      provides: "Step-by-step serving layer (RAG API) implementation plan"
      min_lines: 400
---

<objective>
Create the serving layer implementation plan: RAG retrieval flow, retrieval proof object schema, cite-only-from-retrieval enforcement, query-to-response lifecycle, RETRIEVAL_EXECUTED audit. An engineer must execute without clarifying questions.

Output: `docs/SERVING_LAYER_PLAN.md`
</objective>

<context>
@docs/PRD.md (Section 2.5 Phase E, Section 5.5 Query API)
@docs/AUDIT_ARCHITECTURE.md (RETRIEVAL_EXECUTED, GENERATION_EXECUTED)
@docs/TECH_DECISIONS.md (embedding model for query)
</context>

<tasks>
<task type="auto">
  <name>Write serving layer plan</name>
  <files>docs/SERVING_LAYER_PLAN.md</files>
  <action>
Create docs/SERVING_LAYER_PLAN.md with: (1) Auth (JWT, query scope, tenant_id); (2) Embed query (same model+version as index, 768d); (3) Vector search (Qdrant ANN, metadata filters); (4) Fetch source slices (RDB, object store); (5) Retrieval proof object schema; (6) Cite-only-from-retrieval: every claim must reference chunk_id from proof; (7) Generation (optional): ungrounded claim suppression; (8) POST /api/v1/query/{tenant_id}/search request/response; (9) model_version_match warning; (10) Audit RETRIEVAL_EXECUTED; (11) Online/offline mode (same flow, embedding endpoint differs)
  </action>
</task>
</tasks>

<output>
Create 06-03-SUMMARY.md
</output>
